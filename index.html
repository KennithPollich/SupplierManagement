<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Confidential Supplier Management</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè≠</text></svg>">
    <script>
        // Global flag to track ethers loading
        window.ethersLoaded = false;
        window.ethersLoadCallbacks = [];

        // Load ethers.js with multiple fallbacks
        (function() {
            const scripts = [
                'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js',
                'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js'
            ];

            let currentScript = 0;

            function loadScript() {
                if (currentScript >= scripts.length) {
                    console.error('Failed to load ethers.js from all CDNs');
                    window.ethersLoadCallbacks.forEach(callback => callback(false));
                    return;
                }

                const script = document.createElement('script');
                script.src = scripts[currentScript];
                script.onload = function() {
                    console.log('Ethers.js loaded from:', scripts[currentScript]);
                    // Verify ethers is actually available
                    if (typeof ethers !== 'undefined') {
                        window.ethersLoaded = true;
                        // Call all waiting callbacks
                        window.ethersLoadCallbacks.forEach(callback => callback(true));
                        window.ethersLoadCallbacks = [];
                    } else {
                        console.warn('Script loaded but ethers object not found');
                        currentScript++;
                        loadScript();
                    }
                };
                script.onerror = function() {
                    console.warn('Failed to load from:', scripts[currentScript]);
                    currentScript++;
                    loadScript();
                };
                document.head.appendChild(script);
            }

            loadScript();
        })();

        // Helper function to wait for ethers to load
        window.waitForEthers = function(callback) {
            if (window.ethersLoaded && typeof ethers !== 'undefined') {
                callback(true);
            } else {
                window.ethersLoadCallbacks.push(callback);
            }
        };
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px 20px;
            margin: -20px -20px 40px -20px;
            border-bottom: 4px solid #d4af37;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 400;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .deploy-section {
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .card h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
            padding-bottom: 12px;
            border-bottom: 3px solid #d4af37;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d9e0;
            border-radius: 4px;
            font-size: 15px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1e3c72;
            background: white;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            box-shadow: 0 4px 12px rgba(30, 60, 114, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            font-weight: 500;
            border-left: 4px solid;
        }

        .status.success {
            background: #edf7ed;
            color: #1e4620;
            border-color: #2e7d32;
        }

        .status.error {
            background: #feebee;
            color: #5f2120;
            border-color: #c62828;
        }

        .status.info {
            background: #e3f2fd;
            color: #0d3c61;
            border-color: #1976d2;
        }

        .suppliers-list {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .supplier-item {
            background: #fafbfc;
            border-radius: 6px;
            padding: 24px;
            margin-bottom: 16px;
            border-left: 4px solid #d4af37;
            border: 1px solid #e1e8ed;
            border-left: 4px solid #d4af37;
        }

        .supplier-item h4 {
            color: #1e3c72;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .supplier-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-label {
            font-weight: 600;
            color: #5a6c7d;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 18px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e8ed;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            box-shadow: 0 0 8px rgba(220, 53, 69, 0.4);
        }

        .status-indicator.connected {
            background: #2e7d32;
            box-shadow: 0 0 8px rgba(46, 125, 50, 0.4);
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .supplier-info {
                grid-template-columns: 1fr;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .deploy-progress {
            margin-top: 15px;
            background: #e3f2fd;
            border: 1px solid #1976d2;
            border-radius: 4px;
            padding: 15px;
        }

        .progress-item {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .progress-loading {
            background: #fff9e6;
        }

        .progress-success {
            background: #edf7ed;
        }

        .progress-error {
            background: #feebee;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè≠ Confidential Supplier Management</h1>
            <p>Secure supplier information management with FHE encryption ‚Ä¢ Rating Privacy ‚Ä¢ Async Decryption ‚Ä¢ Real-time Events</p>
        </div>

        <div class="connection-status">
            <div class="status-indicator" id="connectionIndicator"></div>
            <span id="connectionStatus">Initializing...</span>
            <button id="connectBtn" onclick="connectWallet()" style="margin-left: 15px; padding: 10px 20px; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 600; display: none; text-transform: uppercase; letter-spacing: 0.5px;">
                Connect Wallet
            </button>
        </div>

        <div class="main-content">
            <div class="card">
                <h3>üìù Add New Supplier</h3>
                <form id="supplierForm">
                    <div class="form-group">
                        <label for="supplierName">Supplier Name</label>
                        <input type="text" id="supplierName" required>
                    </div>

                    <div class="form-group">
                        <label for="supplierCategory">Category</label>
                        <select id="supplierCategory" required>
                            <option value="">Select Category</option>
                            <option value="raw_materials">Raw Materials</option>
                            <option value="electronics">Electronics</option>
                            <option value="packaging">Packaging</option>
                            <option value="logistics">Logistics</option>
                            <option value="services">Services</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="supplierContact">Contact Information</label>
                        <input type="text" id="supplierContact" required>
                    </div>

                    <div class="form-group">
                        <label for="supplierRating">Quality Rating (1-10)</label>
                        <input type="number" id="supplierRating" min="1" max="10" required>
                    </div>

                    <div class="form-group">
                        <label for="isPreferred">Preferred Supplier</label>
                        <select id="isPreferred" required>
                            <option value="">Select Status</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </div>

                    <button type="submit" class="btn" id="addSupplierBtn">Add Supplier</button>
                </form>
            </div>

            <div class="card">
                <h3>üí° How to Use</h3>
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; font-size: 14px;">
                    <div style="margin-bottom: 10px;"><strong>üìù Add Supplier:</strong> Fill the form above to add a new supplier with FHE encrypted rating</div>
                    <div style="margin-bottom: 10px;"><strong>üîì Decrypt Rating:</strong> Click the decrypt button on your own suppliers to reveal the encrypted rating</div>
                    <div style="margin-bottom: 10px;"><strong>‚úèÔ∏è Update:</strong> Modify rating and preference for suppliers you own</div>
                    <div style="margin-bottom: 10px;"><strong>‚öñÔ∏è Compare:</strong> Compare ratings between suppliers using FHE computation</div>
                    <div style="color: #666; font-size: 12px; margin-top: 10px;">
                        üí° All interactions trigger MetaMask transactions for true blockchain interaction
                    </div>
                </div>
            </div>
        </div>

        <div class="suppliers-list">
            <h3>üìã Registered Suppliers</h3>
            <div id="suppliersList">
                <p>No suppliers found. Connect wallet and add suppliers to get started.</p>
            </div>
        </div>

        <div id="statusMessage"></div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;

        const CONTRACT_ADDRESS = "0x0F00011AE510aEF7A262210B21037484A756a497";

        // Preset supplier data for quick deployment
        const PRESET_SUPPLIERS = [
            {
                name: "TechComponents Ltd",
                category: "electronics",
                contact: "sales@techcomponents.com | +1-555-0123",
                rating: 9,
                isPreferred: true
            },
            {
                name: "Premium Steel Industries",
                category: "raw_materials",
                contact: "orders@premiumsteel.com | +1-555-0234",
                rating: 8,
                isPreferred: true
            },
            {
                name: "EcoPackaging Solutions",
                category: "packaging",
                contact: "info@ecopackaging.com | +1-555-0345",
                rating: 7,
                isPreferred: false
            },
            {
                name: "Global Logistics Express",
                category: "logistics",
                contact: "dispatch@globallogistics.com | +1-555-0456",
                rating: 6,
                isPreferred: false
            },
            {
                name: "Professional Services Corp",
                category: "services",
                contact: "consulting@proservices.com | +1-555-0567",
                rating: 8,
                isPreferred: true
            }
        ];
        const CONTRACT_ABI = [
            "function addSupplier(string memory _name, string memory _category, string memory _contact, uint8 _rating, bool _isPreferred) external",
            "function getSupplier(uint256 _supplierId) external view returns (string memory name, string memory category, string memory contact, uint8 rating, bool isPreferred, address owner)",
            "function updateSupplierRating(uint256 _supplierId, uint8 _newRating) external",
            "function updateSupplierPreference(uint256 _supplierId, bool _isPreferred) external",
            "function getSupplierCount() external view returns (uint256)",
            "function isSupplierPreferred(uint256 _supplierId) external view returns (bool)",
            "function requestRatingDecryption(uint256 _supplierId) external",
            "function compareSupplierRatings(uint256 _supplierId1, uint256 _supplierId2) external view returns (bool)",
            "function supplierExists(uint256 _supplierId) external view returns (bool)",
            "event SupplierAdded(uint256 indexed supplierId, string name, address indexed owner)",
            "event SupplierRatingUpdated(uint256 indexed supplierId, address indexed updater)",
            "event SupplierPreferenceUpdated(uint256 indexed supplierId, address indexed updater)",
            "event RatingDecrypted(address indexed owner, uint8 rating)"
        ];

        async function connectWallet() {
            try {
                // Check if ethers is loaded
                if (typeof ethers === 'undefined') {
                    throw new Error('Ethers.js library not loaded. Please refresh the page.');
                }

                // Check if MetaMask is installed
                if (typeof window.ethereum === 'undefined') {
                    showStatus('‚ùå MetaMask not found. Please install MetaMask extension.', 'error');
                    return false;
                }

                showStatus('üîÑ Connecting to MetaMask...', 'info');

                // Request account access
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (!accounts || accounts.length === 0) {
                    throw new Error('No accounts found. Please unlock MetaMask.');
                }

                // Initialize ethers provider and signer
                provider = new ethers.providers.Web3Provider(window.ethereum);

                // Check current network
                const network = await provider.getNetwork();
                console.log('Connected to network:', network.name, 'Chain ID:', network.chainId);

                // Verify connection to Sepolia testnet
                if (network.chainId !== 11155111) { // Sepolia chain ID
                    showStatus('üîÑ Switching to Sepolia testnet...', 'info');
                    const switched = await switchToSepolia();
                    if (!switched) {
                        throw new Error('Failed to switch to Sepolia testnet. Please switch manually in MetaMask.');
                    }
                    // Refresh provider after network switch
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                }

                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Initialize contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // Set up event listeners once when connecting
                setupEventListeners();

                updateConnectionStatus(true);
                loadSuppliers();
                showStatus('‚úÖ Connected to Sepolia! Ready to use.', 'success');
                return true;

            } catch (error) {
                console.error('Error connecting wallet:', error);

                // Handle specific error types
                if (error.code === 4001) {
                    showStatus('‚ùå User rejected connection request', 'error');
                } else if (error.code === -32002) {
                    showStatus('‚è≥ Connection request already pending. Please check MetaMask.', 'info');
                } else {
                    showStatus('‚ùå Failed to connect wallet: ' + error.message, 'error');
                }
                return false;
            }
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');

            // Always show the connect button after initialization
            connectBtn.style.display = 'inline-block';

            if (connected && userAddress) {
                indicator.classList.add('connected');
                status.textContent = `Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                connectBtn.textContent = 'Connected ‚úì';
                connectBtn.style.background = '#2e7d32';
                connectBtn.disabled = true;
                connectBtn.style.cursor = 'default';
            } else {
                indicator.classList.remove('connected');
                status.textContent = 'Not Connected';
                connectBtn.textContent = 'Connect Wallet';
                connectBtn.style.background = 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)';
                connectBtn.disabled = false;
                connectBtn.style.cursor = 'pointer';
            }
        }

        function setupEventListeners() {
            if (!contract) return;

            // Listen for all contract events
            contract.on('RatingDecrypted', (owner, rating) => {
                if (owner.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`üîì Rating decrypted successfully: ${rating}/10`, 'success');

                    // Update the rating display in the UI
                    const supplierItems = document.querySelectorAll('.supplier-item');
                    supplierItems.forEach((item, index) => {
                        const ratingElement = item.querySelector(`[id^="rating-"]`);
                        if (ratingElement && item.querySelector('h4').textContent.includes('(You)')) {
                            ratingElement.textContent = `‚≠ê Rating: ${rating}/10 (Decrypted)`;
                        }
                    });
                }
            });

            contract.on('SupplierAdded', (supplierId, name, owner) => {
                if (owner.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`‚úÖ Supplier "${name}" added with ID #${supplierId}`, 'success');
                    loadSuppliers();
                }
            });

            contract.on('SupplierRatingUpdated', (supplierId, updater) => {
                if (updater.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`üìä Rating updated for Supplier #${supplierId}`, 'success');
                    loadSuppliers();
                }
            });

            contract.on('SupplierPreferenceUpdated', (supplierId, updater) => {
                if (updater.toLowerCase() === userAddress.toLowerCase()) {
                    showStatus(`‚≠ê Preference updated for Supplier #${supplierId}`, 'success');
                    loadSuppliers();
                }
            });
        }

        async function addSupplier(name, category, contact, rating, isPreferred) {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Adding supplier...', 'info');

                const tx = await contract.addSupplier(name, category, contact, rating, isPreferred);
                showStatus('Transaction submitted. Waiting for confirmation...', 'info');

                await tx.wait();
                showStatus('Supplier added successfully!', 'success');

                loadSuppliers();
                document.getElementById('supplierForm').reset();
            } catch (error) {
                console.error('Error adding supplier:', error);
                showStatus('Failed to add supplier: ' + error.message, 'error');
            }
        }

        // Interactive functions for supplier list buttons
        async function requestDecryptRating(supplierId) {
            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus(`üîì Requesting decryption for Supplier #${supplierId}...`, 'info');

                const tx = await contract.requestRatingDecryption(supplierId);
                showStatus('Decryption request submitted. Waiting for confirmation...', 'info');

                await tx.wait();
                showStatus('Decryption request confirmed. Waiting for async decryption...', 'info');

            } catch (error) {
                console.error('Error requesting rating decryption:', error);
                showStatus('Failed to request rating decryption: ' + error.message, 'error');
            }
        }

        async function openUpdateModal(supplierId) {
            const newRating = prompt('Enter new rating (1-10):');
            if (!newRating || newRating < 1 || newRating > 10) {
                showStatus('‚ùå Invalid rating. Please enter a number between 1 and 10.', 'error');
                return;
            }

            const newPreference = confirm('Is this a preferred supplier?');

            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Updating supplier...', 'info');

                // Update rating
                const ratingTx = await contract.updateSupplierRating(supplierId, parseInt(newRating));
                showStatus('Rating update submitted. Waiting for confirmation...', 'info');
                await ratingTx.wait();

                // Update preference
                const prefTx = await contract.updateSupplierPreference(supplierId, newPreference);
                showStatus('Preference update submitted. Waiting for confirmation...', 'info');
                await prefTx.wait();

                showStatus(`‚úÖ Supplier #${supplierId} updated successfully!`, 'success');

                // Update UI immediately
                document.getElementById(`preferred-${supplierId}`).textContent = newPreference ? 'Yes' : 'No';
                document.getElementById(`rating-${supplierId}`).textContent = `üîí Encrypted (Updated to ${newRating})`;

                setTimeout(loadSuppliers, 2000);

            } catch (error) {
                console.error('Error updating supplier:', error);
                showStatus('Failed to update supplier: ' + error.message, 'error');
            }
        }

        async function compareWithOthers(supplierId) {
            const otherSupplierId = prompt(`Enter another supplier ID to compare with Supplier #${supplierId}:`);
            if (!otherSupplierId || isNaN(otherSupplierId)) {
                showStatus('‚ùå Invalid supplier ID', 'error');
                return;
            }

            try {
                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Comparing suppliers...', 'info');

                const result = await contract.compareSupplierRatings(supplierId, parseInt(otherSupplierId));

                const message = result
                    ? `üèÜ Supplier #${supplierId} has higher or equal rating than Supplier #${otherSupplierId}`
                    : `üèÜ Supplier #${otherSupplierId} has higher rating than Supplier #${supplierId}`;

                showStatus(message, 'success');

            } catch (error) {
                console.error('Error comparing suppliers:', error);
                showStatus('Failed to compare suppliers: ' + error.message, 'error');
            }
        }

        async function verifySupplier() {
            try {
                const supplierId = document.getElementById('verifySupplier').value;
                if (!supplierId) {
                    showStatus('Please enter a supplier ID', 'error');
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                const supplier = await contract.getSupplier(supplierId);
                const isPreferred = await contract.isSupplierPreferred(supplierId);

                showStatus(`Supplier: ${supplier.name} | Category: ${supplier.category} | Rating: [Encrypted - Request Decryption] | Preferred: ${isPreferred}`, 'success');
            } catch (error) {
                console.error('Error verifying supplier:', error);
                showStatus('Failed to verify supplier: ' + error.message, 'error');
            }
        }

        async function requestRatingDecryption() {
            try {
                const supplierId = document.getElementById('verifySupplier').value;
                if (!supplierId) {
                    showStatus('Please enter a supplier ID first', 'error');
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Requesting rating decryption...', 'info');


                const tx = await contract.requestRatingDecryption(supplierId);
                showStatus('Decryption request submitted. Waiting for confirmation...', 'info');

                await tx.wait();
                showStatus('Decryption request confirmed. Waiting for async decryption...', 'info');

            } catch (error) {
                console.error('Error requesting rating decryption:', error);
                showStatus('Failed to request rating decryption: ' + error.message, 'error');
            }
        }

        async function updateSupplierRating() {
            try {
                const supplierId = document.getElementById('verifySupplier').value;
                const newRating = document.getElementById('updateRating').value;

                if (!supplierId || !newRating) {
                    showStatus('Please enter both supplier ID and new rating', 'error');
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Updating rating...', 'info');

                const tx = await contract.updateSupplierRating(supplierId, newRating);
                showStatus('Transaction submitted. Waiting for confirmation...', 'info');

                await tx.wait();
                showStatus('Supplier rating updated successfully!', 'success');

                loadSuppliers();
                document.getElementById('updateRating').value = '';
            } catch (error) {
                console.error('Error updating rating:', error);
                showStatus('Failed to update rating: ' + error.message, 'error');
            }
        }

        async function updateSupplierPreference() {
            try {
                const supplierId = document.getElementById('verifySupplier').value;
                const preference = document.getElementById('updatePreference').value;

                if (!supplierId || preference === '') {
                    showStatus('Please enter supplier ID and select preference status', 'error');
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Updating preference...', 'info');

                const isPreferred = preference === 'true';
                const tx = await contract.updateSupplierPreference(supplierId, isPreferred);
                showStatus('Transaction submitted. Waiting for confirmation...', 'info');

                await tx.wait();
                showStatus('Supplier preference updated successfully!', 'success');

                loadSuppliers();
                document.getElementById('updatePreference').value = '';
            } catch (error) {
                console.error('Error updating preference:', error);
                showStatus('Failed to update preference: ' + error.message, 'error');
            }
        }

        async function compareSuppliers() {
            try {
                const supplierId1 = document.getElementById('verifySupplier').value;
                const supplierId2 = document.getElementById('compareSupplier').value;

                if (!supplierId1 || !supplierId2) {
                    showStatus('Please enter both supplier IDs', 'error');
                    return;
                }

                if (!contract) {
                    throw new Error('Please connect your wallet first');
                }

                showStatus('Comparing suppliers...', 'info');

                const result = await contract.compareSupplierRatings(supplierId1, supplierId2);
                const message = result
                    ? `Supplier #${supplierId1} has higher or equal rating than Supplier #${supplierId2}`
                    : `Supplier #${supplierId2} has higher rating than Supplier #${supplierId1}`;

                showStatus(message, 'success');
            } catch (error) {
                console.error('Error comparing suppliers:', error);
                showStatus('Failed to compare suppliers: ' + error.message, 'error');
            }
        }

        async function loadSuppliers() {
            try {
                if (!contract) return;

                const supplierCount = await contract.getSupplierCount();
                const suppliersList = document.getElementById('suppliersList');

                if (supplierCount.toNumber() === 0) {
                    suppliersList.innerHTML = '<p>No suppliers found. Add suppliers to get started.</p>';
                    return;
                }

                let suppliersHtml = '';
                for (let i = 1; i <= supplierCount.toNumber(); i++) {
                    try {
                        const supplier = await contract.getSupplier(i);
                        const isPreferred = await contract.isSupplierPreferred(i);

                        const isOwner = supplier.owner.toLowerCase() === userAddress.toLowerCase();

                        suppliersHtml += `
                            <div class="supplier-item">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <h4>Supplier #${i}: ${supplier.name}</h4>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                        ${isOwner ? `
                                            <button onclick="requestDecryptRating(${i})" style="padding: 8px 16px; font-size: 12px; background: #1e3c72; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                                                üîì Decrypt
                                            </button>
                                            <button onclick="openUpdateModal(${i})" style="padding: 8px 16px; font-size: 12px; background: #2e7d32; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                                                ‚úèÔ∏è Update
                                            </button>
                                        ` : ''}
                                        <button onclick="compareWithOthers(${i})" style="padding: 8px 16px; font-size: 12px; background: #d4af37; color: #1e3c72; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px;">
                                            ‚öñÔ∏è Compare
                                        </button>
                                    </div>
                                </div>
                                <div class="supplier-info">
                                    <div class="info-item">
                                        <span class="info-label">Category:</span>
                                        <span>${supplier.category}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Contact:</span>
                                        <span>${supplier.contact}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Rating:</span>
                                        <span id="rating-${i}">üîí Encrypted ${isOwner ? '(Click decrypt to view)' : '(Owner only)'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Preferred:</span>
                                        <span id="preferred-${i}">${isPreferred ? 'Yes' : 'No'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Owner:</span>
                                        <span>${supplier.owner.substring(0, 6)}...${supplier.owner.substring(38)} ${isOwner ? '(You)' : ''}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    } catch (error) {
                        console.error(`Error loading supplier ${i}:`, error);
                    }
                }

                suppliersList.innerHTML = suppliersHtml;
            } catch (error) {
                console.error('Error loading suppliers:', error);
                showStatus('Failed to load suppliers: ' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        document.getElementById('supplierForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('supplierName').value;
            const category = document.getElementById('supplierCategory').value;
            const contact = document.getElementById('supplierContact').value;
            const rating = parseInt(document.getElementById('supplierRating').value);
            const isPreferred = document.getElementById('isPreferred').value === 'true';

            await addSupplier(name, category, contact, rating, isPreferred);
        });

        // Sepolia testnet configuration
        const SEPOLIA_CHAIN_ID = '0xaa36a7'; // 11155111 in hex
        const SEPOLIA_CONFIG = {
            chainId: SEPOLIA_CHAIN_ID,
            chainName: 'Sepolia Test Network',
            nativeCurrency: {
                name: 'SepoliaETH',
                symbol: 'ETH',
                decimals: 18
            },
            rpcUrls: ['https://sepolia.infura.io/v3/'],
            blockExplorerUrls: ['https://sepolia.etherscan.io/']
        };

        async function switchToSepolia() {
            try {
                // Try to switch to Sepolia
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: SEPOLIA_CHAIN_ID }],
                });
                return true;
            } catch (switchError) {
                // If the chain is not added, add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [SEPOLIA_CONFIG],
                        });
                        return true;
                    } catch (addError) {
                        console.error('Failed to add Sepolia network:', addError);
                        return false;
                    }
                } else {
                    console.error('Failed to switch to Sepolia:', switchError);
                    return false;
                }
            }
        }

        function initializeApp() {
            console.log('Initializing application...');

            // Use the new ethers loading mechanism
            window.waitForEthers((loaded) => {
                if (!loaded) {
                    console.error('Failed to load ethers.js');
                    document.getElementById('connectionStatus').textContent = 'Failed to load libraries';
                    showStatus('‚ùå Failed to load required libraries. Please refresh the page.', 'error');
                    return;
                }

                console.log('Ethers.js loaded successfully, checking wallet connection...');

                if (typeof window.ethereum !== 'undefined') {
                    console.log('MetaMask detected');

                    // Show the connect button now that everything is ready
                    const connectBtn = document.getElementById('connectBtn');
                    connectBtn.style.display = 'inline-block';

                    // Check for existing connection
                    window.ethereum.request({ method: 'eth_accounts' })
                        .then(accounts => {
                            if (accounts.length > 0) {
                                console.log('Found existing wallet connection, auto-connecting...');
                                connectWallet();
                            } else {
                                console.log('No existing wallet connection found');
                                updateConnectionStatus(false);
                                showStatus('üëÜ Click "Connect Wallet" to get started', 'info');
                            }
                        })
                        .catch(error => {
                            console.error('Error checking existing connection:', error);
                            updateConnectionStatus(false);
                            showStatus('üí° Please connect your MetaMask wallet to begin', 'info');
                        });
                } else {
                    updateConnectionStatus(false);
                    showStatus('‚ùå MetaMask not detected. Please install MetaMask extension.', 'error');
                }
            });
        }

        // Start initialization when page loads
        window.addEventListener('load', initializeApp);

        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('Account changed:', accounts);
                if (accounts.length === 0) {
                    // User disconnected
                    updateConnectionStatus(false);
                    contract = null;
                    provider = null;
                    signer = null;
                    userAddress = null;
                    document.getElementById('suppliersList').innerHTML = '<p>Wallet disconnected. Please connect your wallet to view suppliers.</p>';
                    showStatus('üîå Wallet disconnected', 'info');
                } else {
                    // User switched accounts
                    showStatus('üîÑ Account changed, reconnecting...', 'info');
                    setTimeout(() => connectWallet(), 500);
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Chain changed to:', chainId);
                showStatus('üîÑ Network changed, reconnecting...', 'info');
                setTimeout(() => connectWallet(), 500);
            });
        }
    </script>
</body>
</html>